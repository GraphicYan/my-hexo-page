---
title: Cook-Torrance的BRDF
layout: Cook-Torrance-BRDF
toc: true
date: 2021/04/02 15:23:25
---


Cook-Torrance BRDF的定义:<br />![](assets/post_images/Cook-Torrance-BRDF/image_000.svg#from=paste&height=44&id=u1f6096cf&margin=%5Bobject%20Object%5D&originHeight=44&originWidth=675&originalType=url&status=done&style=none&taskId=udac5ec80-f6f7-4012-958b-43f395591ff&width=675)<br />首先让我们先看看如何计算出![](assets/post_images/Cook-Torrance-BRDF/image_001.svg#from=paste&height=23&id=u653a67dd&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=63&originalType=url&status=done&style=none&taskId=u5a2d08d2-390d-4bea-a1a4-b06e7339dd0&width=63)。
<a name="XKAM8"></a>
## **3.1 漫反射项推导**
在很久之前谈光栅化的时候就提及过，漫反射会均匀的向每个方向反射<br />![](assets/post_images/Cook-Torrance-BRDF/image_002.jpg#from=paste&height=383&id=u5a73d9de&margin=%5Bobject%20Object%5D&originHeight=383&originWidth=617&originalType=url&status=done&style=none&taskId=ub9550757-311a-43ba-9a91-98410a7b861&width=617)<br />因此，漫反射的BRDF一定是一个常数。假设入射光是均匀且遍布整个半球方向，可以得到如下方程：<br />![](assets/post_images/Cook-Torrance-BRDF/image_003.jpg#from=paste&height=261&id=u4adb0527&margin=%5Bobject%20Object%5D&originHeight=261&originWidth=840&originalType=url&status=done&style=none&taskId=u3829682d-e5a3-4a9c-ad35-04c08e61745&width=840)<br />（根据定义![](assets/post_images/Cook-Torrance-BRDF/image_004.svg#from=paste&height=23&id=uf7abef4b&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=137&originalType=url&status=done&style=none&taskId=u97cac1da-3352-4542-ba99-db307a11830&width=137)， 积分过程省略） 由于假设入射光是均匀且遍布整个半球方向，所以![](assets/post_images/Cook-Torrance-BRDF/image_005.svg#from=paste&height=23&id=u7ffcba90&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=21&originalType=url&status=done&style=none&taskId=ub3c6f941-f93b-4127-b266-6e2e44f669d&width=21)与方向无关，且等于![](assets/post_images/Cook-Torrance-BRDF/image_006.svg#from=paste&height=23&id=u85e8414b&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=24&originalType=url&status=done&style=none&taskId=uc1baa105-9c17-47e6-a4aa-8f325ebf36c&width=24)，最终约去两边![](assets/post_images/Cook-Torrance-BRDF/image_007.svg#from=paste&height=20&id=uf94ccd9e&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=14&originalType=url&status=done&style=none&taskId=ud7d5515c-625f-4429-a059-5998a307cf4&width=14)，得到结果：<br />![](assets/post_images/Cook-Torrance-BRDF/image_008.svg#from=paste&height=57&id=u6152c488&margin=%5Bobject%20Object%5D&originHeight=57&originWidth=675&originalType=url&status=done&style=none&taskId=u0e8479cf-65ba-4bd9-a04c-d566cd5c66f&width=675)<br />但有一点要注意的是，这里并没有考虑能量被吸收，将反射率考虑进来之后，得到最终的漫反射BRDF：<br />![](assets/post_images/Cook-Torrance-BRDF/image_009.svg#from=paste&height=54&id=u00c4a599&margin=%5Bobject%20Object%5D&originHeight=54&originWidth=675&originalType=url&status=done&style=none&taskId=u94796a54-97fe-4089-8652-01cd37b9f2c&width=675)<br />这里的![](assets/post_images/Cook-Torrance-BRDF/image_010.svg#from=paste&height=20&id=ubaa9c8d7&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=11&originalType=url&status=done&style=none&taskId=u9ed945a7-d18f-440c-88a3-f36e1b9853a&width=11)可以类比光栅化当中的漫反射系数去理解，本质就是一个3维向量，含有物体表面的颜色信息。
<a name="YoFOT"></a>
## **3.2 镜面反射项推导**
漫反射项的形式简单且比较容易理解，但是对于镜面反射项，其形式则要更加高级一点：<br />![](assets/post_images/Cook-Torrance-BRDF/image_011.svg#from=paste&height=68&id=ub446b41a&margin=%5Bobject%20Object%5D&originHeight=68&originWidth=675&originalType=url&status=done&style=none&taskId=u6f5e5c5b-7b9f-4dcd-8cc9-45382254769&width=675)<br />看起来确实有些唬人，但是不要急，让我们先简单的解释一下式子当中各项参数，之和再一步步的进行详细阐述： 其中![](assets/post_images/Cook-Torrance-BRDF/image_012.svg#from=paste&height=15&id=u19fc8cb3&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=10&originalType=url&status=done&style=none&taskId=u0aa36a34-67d6-46a4-a7a9-546d4da5d02&width=10)为反射方向(观察方向)，![](assets/post_images/Cook-Torrance-BRDF/image_013.svg#from=paste&height=20&id=u29652c75&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=6&originalType=url&status=done&style=none&taskId=u4d9f2d7f-566b-4b21-9d11-b21e72be70d&width=6)为入射方向，![](assets/post_images/Cook-Torrance-BRDF/image_014.svg#from=paste&height=15&id=u762f01cf&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=13&originalType=url&status=done&style=none&taskId=uaa5228aa-e424-41e6-b043-69f138bbd63&width=13)为**宏观表面法向**，![](assets/post_images/Cook-Torrance-BRDF/image_015.svg#from=paste&height=20&id=u3e9e3193&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=ud9fca269-ad25-4084-8bbe-ba147900666&width=12)为**微平面法向**<br />分子上的![](assets/post_images/Cook-Torrance-BRDF/image_016.svg#from=paste&height=23&id=u82397aba&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=68&originalType=url&status=done&style=none&taskId=ub78efde6-6563-4074-ac62-18a91bb96bd&width=68)为3个不同的函数：<br />**函数D：法线分布函数(Normal Distribution Function)，其代表了所有微观角度下微小镜面法线的分布情况，粗糙表面法线分布相对均匀，光滑表面法线分布相对集中 (这种解释可能会有些抽象，后面会给出更加直观的物理上的解释)**<br />**函数G：几何函数(Geometry Function)，描述了微平面自遮挡的属性。当一个平面相对比较粗糙的时候，平面表面上的微平面有可能挡住其他的微平面从而减少表面所反射的光线。**<br />**函数F：菲涅尔方程(Fresnel Rquation)，描述了物体表面在不同入射光角度下反射光线所占的比率**<br />可以看出无论是几何函数G，还是菲涅尔方程F，都是由于观察方向，入射方向的不同所导致的只有部分光线能够被反射<br />![](assets/post_images/Cook-Torrance-BRDF/image_017.svg#from=paste&height=45&id=u622aee9c&margin=%5Bobject%20Object%5D&originHeight=45&originWidth=675&originalType=url&status=done&style=none&taskId=uc55f9c37-063e-4cd3-9efc-26a77979327&width=675)![](assets/post_images/Cook-Torrance-BRDF/image_018.svg#from=paste&height=45&id=u1649bbb3&margin=%5Bobject%20Object%5D&originHeight=45&originWidth=675&originalType=url&status=done&style=none&taskId=u58549714-3fc8-44ba-8f6b-e9739521826&width=675)<br />因此先假设没有光线会为上述两个函数产生损失（即二者都=1），方便我们进行BRDF推导。<br />在上文中，函数![](assets/post_images/Cook-Torrance-BRDF/image_019.svg#from=paste&height=20&id=u4e6bcaf3&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=17&originalType=url&status=done&style=none&taskId=uc4d924af-dc8b-46ad-aa92-1183dd25c0d&width=17)被解释为微观角度下微小镜面法线的分布函数，其函数接受一个参数为![](assets/post_images/Cook-Torrance-BRDF/image_020.svg#from=paste&height=20&id=ud4180fc2&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=u614dabff-8849-44b9-addb-481b3b9662b&width=12)，即微平面的法线向量，**更直观的来说，D(h)的物理含义为所有法向为**![](assets/post_images/Cook-Torrance-BRDF/image_021.svg#from=paste&height=20&id=uaa99bc40&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=u6d5adb96-6221-4c11-8d5e-d7a3716b99e&width=12)**的微平面的面积**，没错就是面积，你没有看错，只不过我们要说明的是什么条件下的，法线方向为![](assets/post_images/Cook-Torrance-BRDF/image_022.svg#from=paste&height=20&id=u09b05592&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=u744cc614-794f-4ca1-aac0-68039218316&width=12)的微平面面积，需要加上限制：<br />(1) 第一，我们所关注的区域仅仅是一个着色点，或者说一个微分面积元，因此![](assets/post_images/Cook-Torrance-BRDF/image_023.svg#from=paste&height=26&id=u896d9440&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=u931aee85-a38c-4667-a23d-e39866d99f4&width=46)所指的应该是单位面积下，所有法向为![](assets/post_images/Cook-Torrance-BRDF/image_024.svg#from=paste&height=20&id=u8ef475d2&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=u1aab23fb-21a2-41a4-ad44-52245f1d2b2&width=12)的微平面的面积。<br />(2) 第二， 微平面的法线![](assets/post_images/Cook-Torrance-BRDF/image_025.svg#from=paste&height=20&id=uc1db05a7&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=uea16520e-7b69-40b8-b6fa-34453bf6939&width=12)是一个离散数值，而微平面法线分布是连续的，因此是几乎不可能精确的找到法线为某个固定值的微平面的，因此为![](assets/post_images/Cook-Torrance-BRDF/image_026.svg#from=paste&height=26&id=u8b3bfd46&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=ubd93c239-220f-4d3e-ad4c-b297a10bdb5&width=46)完善第二个限制，即加上每单位立体角，使其变成一个范围，此时![](assets/post_images/Cook-Torrance-BRDF/image_027.svg#from=paste&height=26&id=u7ae81139&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=ud276b49a-2d8f-4f11-8945-c9d8d317d2b&width=46)则变成了每单位立体角所有法向为![](assets/post_images/Cook-Torrance-BRDF/image_028.svg#from=paste&height=20&id=u86d3351b&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=u46d7377b-e25a-4b76-b5b7-d566f7e2836&width=12)的微平面的面积。<br />(关于第二点限制可能有些不太好理解，其实这可以类比连续型随机变量取一点概率为0，道理是一样的)<br />好了，加上这两点限制之后，便得到了![](assets/post_images/Cook-Torrance-BRDF/image_029.svg#from=paste&height=26&id=u7b903e31&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=u0fc18995-ad4f-45b5-a623-6a977092842&width=46)的真正的物理含义，**即每单位面积,每单位立体角所有法向为**![](assets/post_images/Cook-Torrance-BRDF/image_030.svg#from=paste&height=20&id=u11b758db&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=uf0b8d062-d4a4-48a2-aee4-02ee2ed033e&width=12)**的微平面的面积**。接下来当确定了观察方向![](assets/post_images/Cook-Torrance-BRDF/image_031.svg#from=paste&height=15&id=u1f1c7a05&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=10&originalType=url&status=done&style=none&taskId=u9e6b3038-a66f-41ac-b4d0-c500e4f780d&width=10)和入射方向![](assets/post_images/Cook-Torrance-BRDF/image_032.svg#from=paste&height=20&id=u3446b9be&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=6&originalType=url&status=done&style=none&taskId=u2a8b6a30-efca-46f0-8ea8-7531fde1660&width=6)之后，我们所真正在乎的能对镜面反射做出贡献的只有法线为![](assets/post_images/Cook-Torrance-BRDF/image_033.svg#from=paste&height=26&id=u360ed13d&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=174&originalType=url&status=done&style=none&taskId=u67f6bdaa-3232-4dec-8c15-7edefd681a3&width=174)的微平面，如下图所示：<br />![](assets/post_images/Cook-Torrance-BRDF/image_034.jpeg#from=paste&height=203&id=ucbf0b9a9&margin=%5Bobject%20Object%5D&originHeight=203&originWidth=915&originalType=url&status=done&style=none&taskId=u7040579b-cc69-4e8f-ae68-0f366dd5432&width=915)<br />只有图中红色的微平面才能对镜面反射做出贡献，利用刚刚得到的关于![](assets/post_images/Cook-Torrance-BRDF/image_035.svg#from=paste&height=26&id=u576e6896&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=u3f0dc219-ef89-4867-833d-e372ba86aa0&width=46)的物理含义，不难计算得到，所有红色微平面面积![](assets/post_images/Cook-Torrance-BRDF/image_036.svg#from=paste&height=26&id=u02ac6fad&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=223&originalType=url&status=done&style=none&taskId=u6ad41389-ead5-4144-9ac6-799ebf80f70&width=223)<br />(本文以下用![](assets/post_images/Cook-Torrance-BRDF/image_037.svg#from=paste&height=18&id=u5f1f6bf9&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=ue6a68a5c-3c87-401f-b1c4-646e09c78d8&width=20)代替入射方向![](assets/post_images/Cook-Torrance-BRDF/image_038.svg#from=paste&height=20&id=uf2219594&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=6&originalType=url&status=done&style=none&taskId=ua294b6ee-a741-4c13-9de7-91f5923d83b&width=6)，![](assets/post_images/Cook-Torrance-BRDF/image_039.svg#from=paste&height=18&id=u223b1d12&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=22&originalType=url&status=done&style=none&taskId=u17976c48-1932-4046-b592-e85592500fd&width=22)代替观察方向![](assets/post_images/Cook-Torrance-BRDF/image_040.svg#from=paste&height=15&id=uec90143f&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=10&originalType=url&status=done&style=none&taskId=u863661e4-ba3c-44c8-a97c-fe470fa67df&width=10)，![](assets/post_images/Cook-Torrance-BRDF/image_041.svg#from=paste&height=18&id=u64fb4020&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=uc6e34ddb-9972-4e98-a27f-cf8c68f5996&width=24)代替微平面法向![](assets/post_images/Cook-Torrance-BRDF/image_042.svg#from=paste&height=20&id=u952cdf9b&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=uac7e9f03-58ce-47fa-a6df-2433094fb0e&width=12))<br />那么根据该面积可以计算出入射的辐射通量<br />![](assets/post_images/Cook-Torrance-BRDF/image_043.svg#from=paste&height=95&id=u2be57d99&margin=%5Bobject%20Object%5D&originHeight=95&originWidth=675&originalType=url&status=done&style=none&taskId=ufaf458e7-9785-4cf4-96b0-d48a15cd0af&width=675)<br />(![](assets/post_images/Cook-Torrance-BRDF/image_044.svg#from=paste&height=29&id=u73444e2d&margin=%5Bobject%20Object%5D&originHeight=29&originWidth=80&originalType=url&status=done&style=none&taskId=u228ac38d-bdf5-4a02-b33e-8ea905c60b2&width=80)是![](assets/post_images/Cook-Torrance-BRDF/image_045.svg#from=paste&height=26&id=u9197e6e0&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=67&originalType=url&status=done&style=none&taskId=ub0fa703e-3fba-4b7c-8336-dbfce52d3f0&width=67)在入射光线方向的投影垂直面积，![](assets/post_images/Cook-Torrance-BRDF/image_046.svg#from=paste&height=23&id=ud279c92d&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=20&originalType=url&status=done&style=none&taskId=u0de0326f-d16b-4917-85b6-4da189d890b&width=20)为入射光线![](assets/post_images/Cook-Torrance-BRDF/image_047.svg#from=paste&height=18&id=u32cb97f7&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=ub813f240-8934-4846-8257-d14ddfddb1e&width=20)与微平面法线![](assets/post_images/Cook-Torrance-BRDF/image_048.svg#from=paste&height=18&id=ub334ea57&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=u1e910778-b1c7-4d93-be20-78f0c36c8e5&width=24)的夹角)<br />因为此时不考虑菲涅尔项以及几何函数所带来的光线损失，所以<br />![](assets/post_images/Cook-Torrance-BRDF/image_049.svg#from=paste&height=44&id=ufcf3f559&margin=%5Bobject%20Object%5D&originHeight=44&originWidth=675&originalType=url&status=done&style=none&taskId=u8e073820-5875-4b29-bf9e-70d855ac98d&width=675)<br />进一步，根据辐出度radiance定义，计算得<br />![](assets/post_images/Cook-Torrance-BRDF/image_050.svg#from=paste&height=65&id=u43a35287&margin=%5Bobject%20Object%5D&originHeight=65&originWidth=675&originalType=url&status=done&style=none&taskId=u38580368-deed-4a86-a919-b960985232b&width=675)<br />最后由BRDF定易得<br />![](assets/post_images/Cook-Torrance-BRDF/image_051.svg#from=paste&height=68&id=uf0155597&margin=%5Bobject%20Object%5D&originHeight=68&originWidth=675&originalType=url&status=done&style=none&taskId=uef11399e-9d45-492d-ab8b-61174f81d74&width=675)<br />其中，![](assets/post_images/Cook-Torrance-BRDF/image_052.svg#from=paste&height=23&id=u5adbd982&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=17&originalType=url&status=done&style=none&taskId=u7f874af5-0e7f-4570-9abe-c69088e4e73&width=17)是入射光线![](assets/post_images/Cook-Torrance-BRDF/image_053.svg#from=paste&height=18&id=ubada6e0b&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=u57dc33f7-f09f-4200-869f-1c083d8f442&width=20)与宏观法线方向![](assets/post_images/Cook-Torrance-BRDF/image_054.svg#from=paste&height=15&id=ubf46313f&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=13&originalType=url&status=done&style=none&taskId=u9e4d59b5-f631-4960-9920-2b105e9ee73&width=13)的夹角，![](assets/post_images/Cook-Torrance-BRDF/image_055.svg#from=paste&height=23&id=u59ee9ec2&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=19&originalType=url&status=done&style=none&taskId=u8401fdf5-1ced-469c-9da9-227650336a7&width=19)是出射光线![](assets/post_images/Cook-Torrance-BRDF/image_056.svg#from=paste&height=18&id=ue668bdcc&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=22&originalType=url&status=done&style=none&taskId=uf4baaa26-ad93-4631-9da5-4f5ade189d9&width=22)与宏观法线方向![](assets/post_images/Cook-Torrance-BRDF/image_057.svg#from=paste&height=15&id=uc1ca41a3&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=13&originalType=url&status=done&style=none&taskId=ub49734a3-7497-4017-a29b-a193030e95a&width=13)的夹角，![](assets/post_images/Cook-Torrance-BRDF/image_058.svg#from=paste&height=23&id=u41c5adf2&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=20&originalType=url&status=done&style=none&taskId=ua9a6c0f0-1331-4f88-aea6-0f549bf0964&width=20)是入射光线![](assets/post_images/Cook-Torrance-BRDF/image_059.svg#from=paste&height=18&id=u17bccd56&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=u446e7c40-8a0a-4546-a6e7-eaccd3825e6&width=20)与微平面法线方向![](assets/post_images/Cook-Torrance-BRDF/image_060.svg#from=paste&height=18&id=ua0ca7b84&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=ubfb37115-e132-4906-9da3-b67bbad760e&width=24)的夹角。<br />最后一步，只需要找到![](assets/post_images/Cook-Torrance-BRDF/image_061.svg#from=paste&height=26&id=u96ebdf3e&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=78&originalType=url&status=done&style=none&taskId=u46c12d46-5127-4faa-9bb3-ad3db631412&width=78)的比值，就可以成功推导出镜面反射的BRDF了。那么![](assets/post_images/Cook-Torrance-BRDF/image_062.svg#from=paste&height=26&id=u4593518c&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=78&originalType=url&status=done&style=none&taskId=u955a3c77-af7b-4696-8e52-5cb00cb684a&width=78)的从直观角度去看到底是指什么呢？很简单，如下图所示：<br />![](assets/post_images/Cook-Torrance-BRDF/image_063.jpeg#from=paste&height=434&id=u8b311ac9&margin=%5Bobject%20Object%5D&originHeight=434&originWidth=768&originalType=url&status=done&style=none&taskId=ub29ff17b-6e03-4eb3-a521-cd4c123e32f&width=768)<br />首先固定入射方向![](assets/post_images/Cook-Torrance-BRDF/image_064.svg#from=paste&height=18&id=ucfde2fc1&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=u48ecb6dd-0222-4b93-a119-5a060a3890f&width=20)，微分立体角![](assets/post_images/Cook-Torrance-BRDF/image_065.svg#from=paste&height=23&id=u3f469000&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=35&originalType=url&status=done&style=none&taskId=u87e24a62-422c-4655-a85d-53429855b63&width=35)是一个很小的范围，那么这样一个很小的范围所对应的反射角自然也是一个很小的范围![](assets/post_images/Cook-Torrance-BRDF/image_066.svg#from=paste&height=23&id=uedd1ed36&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=33&originalType=url&status=done&style=none&taskId=u13d58571-361c-4fb4-8a88-2a52ba24201&width=33)，形象的来看，就是转动平面得到所有微观法线在![](assets/post_images/Cook-Torrance-BRDF/image_067.svg#from=paste&height=23&id=u4d5596dd&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=35&originalType=url&status=done&style=none&taskId=ubc10c9c9-0faf-4b94-a80a-e5f4c394d58&width=35)范围之内的平面，通过这些微平面，所得到的反射范围。那么如何求得这样一个比值呢，以入射方向![](assets/post_images/Cook-Torrance-BRDF/image_068.svg#from=paste&height=18&id=u1a5e69f2&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=20&originalType=url&status=done&style=none&taskId=u2cb5570f-0039-478c-8e46-2e771a736a9&width=20)为![](assets/post_images/Cook-Torrance-BRDF/image_069.svg#from=paste&height=15&id=u7288bf11&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=10&originalType=url&status=done&style=none&taskId=ud7ff3d50-98e2-468c-afb8-a6149cdbad9&width=10)轴负方向，建立球面坐标系如下：<br />![](assets/post_images/Cook-Torrance-BRDF/image_070.jpeg#from=paste&height=694&id=ud2c8ebab&margin=%5Bobject%20Object%5D&originHeight=694&originWidth=717&originalType=url&status=done&style=none&taskId=u87d8b61f-3f96-4026-9dfc-50bf129586a&width=717)<br />(嗨呀，画的真丑，凑合看看吧)<br />根据图中的**单位**球面坐标系以及标注的角度，不难得出![](assets/post_images/Cook-Torrance-BRDF/image_071.svg#from=paste&height=18&id=u82618f4e&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=u20872285-7e87-4b87-a8ef-2e3d780ee90&width=24)的球面坐标为(1，![](assets/post_images/Cook-Torrance-BRDF/image_072.svg#from=paste&height=23&id=ub64989d5&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=20&originalType=url&status=done&style=none&taskId=u429d7204-00d1-4f4d-b7a3-dd84c0bd8d9&width=20)，![](assets/post_images/Cook-Torrance-BRDF/image_073.svg#from=paste&height=23&id=u8bd5d5ba&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=12&originalType=url&status=done&style=none&taskId=ue888d34a-b25f-4c4e-ba0d-6a06bc4a1f6&width=12))，则不难计算出微分立体角<br />![](assets/post_images/Cook-Torrance-BRDF/image_074.svg#from=paste&height=23&id=ue05ee942&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=168&originalType=url&status=done&style=none&taskId=u12ac507e-97a8-45b2-9228-f42443c10e0&width=168)<br />同时![](assets/post_images/Cook-Torrance-BRDF/image_075.svg#from=paste&height=18&id=u93f70d14&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=22&originalType=url&status=done&style=none&taskId=u76be30ae-cf4b-4cac-ac8d-a9193fac966&width=22)的球面坐标为(1，2![](assets/post_images/Cook-Torrance-BRDF/image_076.svg#from=paste&height=23&id=uea8d82ad&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=20&originalType=url&status=done&style=none&taskId=u1a6e2986-4df3-4732-96bf-219f10bff3e&width=20)，![](assets/post_images/Cook-Torrance-BRDF/image_077.svg#from=paste&height=23&id=u2c83b7c2&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=12&originalType=url&status=done&style=none&taskId=uac8a5ce5-4a71-4024-8ad7-638cde96e2a&width=12))，因为![](assets/post_images/Cook-Torrance-BRDF/image_078.svg#from=paste&height=20&id=u48c8d1a2&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=10&originalType=url&status=done&style=none&taskId=u9dfaae3e-5ee7-4a41-b146-530ba3d2ca4&width=10)角变为两倍，那么对于![](assets/post_images/Cook-Torrance-BRDF/image_079.svg#from=paste&height=18&id=u380fbfc4&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=22&originalType=url&status=done&style=none&taskId=uc96fd74b-71a6-4280-91af-f2d5afca108&width=22)来说![](assets/post_images/Cook-Torrance-BRDF/image_080.svg#from=paste&height=20&id=ue1ad77dc&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=10&originalType=url&status=done&style=none&taskId=uad9d05e4-b55a-45e1-a93c-134bf1eb2c6&width=10)角度的微分变化应该也为两倍，因此计算得到<br />![](assets/post_images/Cook-Torrance-BRDF/image_081.svg#from=paste&height=23&id=ud32a9b27&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=419&originalType=url&status=done&style=none&taskId=u21418cda-baf8-4e62-a3b3-b6986432592&width=419)<br />此时已经知道了![](assets/post_images/Cook-Torrance-BRDF/image_082.svg#from=paste&height=23&id=ue6d56396&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=35&originalType=url&status=done&style=none&taskId=u5227ffa9-ce6d-43d3-903e-b041842d5d3&width=35)与![](assets/post_images/Cook-Torrance-BRDF/image_083.svg#from=paste&height=23&id=u8c43fe24&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=33&originalType=url&status=done&style=none&taskId=u594429e0-965b-4026-b14e-285f38215a2&width=33)，那么<br />![](assets/post_images/Cook-Torrance-BRDF/image_084.svg#from=paste&height=62&id=u7a6e7766&margin=%5Bobject%20Object%5D&originHeight=62&originWidth=675&originalType=url&status=done&style=none&taskId=u464727f2-6a35-4766-8324-36b6b97c480&width=675)<br />将此关系代入上面的镜面BRDF得到：<br />![](assets/post_images/Cook-Torrance-BRDF/image_085.svg#from=paste&height=65&id=u74e3ad68&margin=%5Bobject%20Object%5D&originHeight=65&originWidth=675&originalType=url&status=done&style=none&taskId=u2ad1f399-8e45-4dae-80d9-a9769ebdc17&width=675)<br />最后将我们一开始忽略掉的菲涅尔项与几何函数重新加入<br />![](assets/post_images/Cook-Torrance-BRDF/image_086.svg#from=paste&height=65&id=u2b7939e9&margin=%5Bobject%20Object%5D&originHeight=65&originWidth=675&originalType=url&status=done&style=none&taskId=ud15de48e-7ab5-4879-aa11-43cb9ac871a&width=675)<br />至此就已经完成了Cook-Torrance BRDF的所有推导了。<br />**tips:**还有一点有关![](assets/post_images/Cook-Torrance-BRDF/image_087.svg#from=paste&height=26&id=uaf9f5976&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=46&originalType=url&status=done&style=none&taskId=uaed4683e-800b-4e2f-accf-2bf6d7bd6a0&width=46)可以注意的是，对于法线分布函数的设计应该满足<br />![](assets/post_images/Cook-Torrance-BRDF/image_088.svg#from=paste&height=60&id=u6e0028d6&margin=%5Bobject%20Object%5D&originHeight=60&originWidth=675&originalType=url&status=done&style=none&taskId=ue6c6774f-31e6-4672-a41d-c9021b568ad&width=675)<br />（![](assets/post_images/Cook-Torrance-BRDF/image_089.svg#from=paste&height=20&id=udb79940e&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=10&originalType=url&status=done&style=none&taskId=uaf0c2b74-2db9-4ca8-b3f2-26600baeadf&width=10)为微平面法向![](assets/post_images/Cook-Torrance-BRDF/image_090.svg#from=paste&height=18&id=u64fe1b7a&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=uda5ead86-a68d-4307-a71c-a8fb8ab37a2&width=24)与宏观法向![](assets/post_images/Cook-Torrance-BRDF/image_091.svg#from=paste&height=15&id=u7005b005&margin=%5Bobject%20Object%5D&originHeight=15&originWidth=13&originalType=url&status=done&style=none&taskId=u9ab9a2b6-0a6a-489c-9517-5cdcee1901e&width=13)的夹角） 从几何角度很容易解释，因为![](assets/post_images/Cook-Torrance-BRDF/image_092.svg#from=paste&height=26&id=u6c51eed6&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=118&originalType=url&status=done&style=none&taskId=u9736aac9-7467-49e5-a208-df827a6ef27&width=118)是着色点(微分面积元)内所有法向为![](assets/post_images/Cook-Torrance-BRDF/image_093.svg#from=paste&height=20&id=u615464fa&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=12&originalType=url&status=done&style=none&taskId=ua7d087f1-79b6-4571-a769-5dabddc3d0a&width=12)的微平面的面积，乘上![](assets/post_images/Cook-Torrance-BRDF/image_094.svg#from=paste&height=20&id=u1acef715&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=39&originalType=url&status=done&style=none&taskId=u7a681052-22b0-4487-8043-0195a387a18&width=39)则代表将其投影至宏观平面上，将所有的法线方向![](assets/post_images/Cook-Torrance-BRDF/image_095.svg#from=paste&height=18&id=ue5951763&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=24&originalType=url&status=done&style=none&taskId=u6360e1a9-024f-4918-8f77-039d5c49ce8&width=24)的投影面积都加起来，自然还是原来的微分面积元![](assets/post_images/Cook-Torrance-BRDF/image_096.svg#from=paste&height=20&id=ubd58d936&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=27&originalType=url&status=done&style=none&taskId=u011ae27d-852d-47cb-baf0-dce8aad8e5b&width=27)保持不变，同时将上式子进一步化简可得：<br />![](assets/post_images/Cook-Torrance-BRDF/image_097.svg#from=paste&height=60&id=uecffb03b&margin=%5Bobject%20Object%5D&originHeight=60&originWidth=675&originalType=url&status=done&style=none&taskId=u057845c6-52c1-4a2e-ad9a-26e5d5947e6&width=675)<br />可以验证一下广泛使用的GGX (Trowbridge-Reitz)法线分布函数：<br />![](assets/post_images/Cook-Torrance-BRDF/image_098.svg#from=paste&height=48&id=ub06d7f99&margin=%5Bobject%20Object%5D&originHeight=48&originWidth=675&originalType=url&status=done&style=none&taskId=ua22216fe-8b04-4bb0-915d-08707bad808&width=675)![](assets/post_images/Cook-Torrance-BRDF/image_099.svg#from=paste&height=89&id=u8356b9cd&margin=%5Bobject%20Object%5D&originHeight=89&originWidth=675&originalType=url&status=done&style=none&taskId=ud5a25518-8c35-49a3-8bc5-cc16c02754d&width=675)<br />验证如下：<br />![](assets/post_images/Cook-Torrance-BRDF/image_100.svg#from=paste&height=368&id=uce17af15&margin=%5Bobject%20Object%5D&originHeight=368&originWidth=675&originalType=url&status=done&style=none&taskId=u3514e698-2ce4-435e-a212-5e57255ebc0&width=675)
<a name="gkvzQ"></a>
## **3.3 菲涅尔方程与几何函数的补充**
最后再简略的讲一下菲尼尔方程和几何函数对光线损失的影响吧。
<a name="r41wW"></a>
### **3.3.1 菲涅尔方程**
菲涅尔方程是为了描述物理世界当中，观察角度与法线夹角越大反射程度一般越大的一种情形，但是精确计算计算消耗较大，一般用Fresnel-Schlick近似法求得近似解<br />![](assets/post_images/Cook-Torrance-BRDF/image_101.svg#from=paste&height=48&id=u275cb674&margin=%5Bobject%20Object%5D&originHeight=48&originWidth=675&originalType=url&status=done&style=none&taskId=ud759bc36-6036-4e76-9af2-4e9bac93a26&width=675)<br />![](assets/post_images/Cook-Torrance-BRDF/image_102.svg#from=paste&height=23&id=u8579b998&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=23&originalType=url&status=done&style=none&taskId=ue8f29765-0b17-42bc-bb62-cde582239a2&width=23)表示平面的基础反射率，它是利用所谓折射系数(Indices of Refraction)计算得出的。越是朝球面掠角的方向上看（此时视线和表面法线的夹角接近90度）菲涅尔现象就越明显，反光就越强。但是根据折射系数只能算出电介质(非导体)的![](assets/post_images/Cook-Torrance-BRDF/image_103.svg#from=paste&height=23&id=u72772f63&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=23&originalType=url&status=done&style=none&taskId=u784ed1e0-5eb8-4610-aca1-03ff619ff5b&width=23)为了兼容导体，一般会将![](assets/post_images/Cook-Torrance-BRDF/image_104.svg#from=paste&height=23&id=u5acc1d0a&margin=%5Bobject%20Object%5D&originHeight=23&originWidth=23&originalType=url&status=done&style=none&taskId=u6620d40a-ef01-47ad-b74c-757aad02b69&width=23)提前计算出来，再代入方程：<br />![](assets/post_images/Cook-Torrance-BRDF/image_105.jpg#from=paste&height=453&id=u1729e6a7&margin=%5Bobject%20Object%5D&originHeight=453&originWidth=1091&originalType=url&status=done&style=none&taskId=ucae89221-e43f-4596-9e5b-b7fe284a510&width=1091)<br />关于菲涅尔方程的详细介绍，我在光线追踪笔记中的4.2，4.3节中由详细提及，这里就不再重复了。<br />**https://zhuanlan.zhihu.com/p/144403005**zhuanlan.zhihu.com[![](assets/post_images/Cook-Torrance-BRDF/image_106.svg#from=paste&height=120&id=u10d144eb&margin=%5Bobject%20Object%5D&originHeight=120&originWidth=120&originalType=url&status=done&style=none&taskId=ue6c2f4f7-d14b-4420-aee1-4f0fadbc002&width=120)](https://zhuanlan.zhihu.com/p/144403005)
<a name="N6ZZQ"></a>
### **3.3.2几何函数**
几何函数G是为了表示微平面的自遮挡从而引起的光线损失，一般会出现如下两种的遮挡情况<br />![](assets/post_images/Cook-Torrance-BRDF/image_107.jpg#from=paste&height=284&id=u5ff07eb7&margin=%5Bobject%20Object%5D&originHeight=284&originWidth=847&originalType=url&status=done&style=none&taskId=u2a6eea68-581f-498a-8102-1285d0e3952&width=847)<br />左边一幅图中是入射光线无法照射到一些微平面，这种情况称为Shadowing，右边图中是反射光线无法正常到达人眼，称为Masking，而几何函数![](assets/post_images/Cook-Torrance-BRDF/image_108.svg#from=paste&height=20&id=uf6173422&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=16&originalType=url&status=done&style=none&taskId=u0f7c22d7-f9d1-456a-9a93-aa7844dffe4&width=16)正是为了模拟出这两种情况所导致的光线所示，在UE4中采用了Schlick-GGX来进行建模：<br />![](assets/post_images/Cook-Torrance-BRDF/image_109.svg#from=paste&height=63&id=u17a7291e&margin=%5Bobject%20Object%5D&originHeight=63&originWidth=675&originalType=url&status=done&style=none&taskId=u2e79dc45-a861-4682-b63a-fa63cc2a409&width=675)![](assets/post_images/Cook-Torrance-BRDF/image_110.svg#from=paste&height=59&id=u7c33c5be&margin=%5Bobject%20Object%5D&originHeight=59&originWidth=675&originalType=url&status=done&style=none&taskId=u34f1f161-fd92-4ad3-b6c1-f2263a7be7a&width=675)![](assets/post_images/Cook-Torrance-BRDF/image_111.svg#from=paste&height=45&id=uf3287aaa&margin=%5Bobject%20Object%5D&originHeight=45&originWidth=675&originalType=url&status=done&style=none&taskId=u497cf7b4-1d82-4084-8d2b-f9acf7fc0fb&width=675)<br />(一般来说表面粗糙程度Roughness越大，遮挡程度越大)
