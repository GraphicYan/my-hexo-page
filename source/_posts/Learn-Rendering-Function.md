---
title: 理解渲染方程
layout: Learn-Rendering-Function
toc: true
date: 2021/03/29 14:23:29
---

渲染方程知识在反射方程的基础之上添加了一个自发光项(Emission term)，从而使得反射方程更加的general：<br />![](assets/post_images/Learn-Rendering-Function/image_000.svg#from=paste&height=60&id=u5053a189&margin=%5Bobject%20Object%5D&originHeight=60&originWidth=675&originalType=url&status=done&style=none&taskId=uf97a40c6-c7d2-4760-acd7-1ffa0f08202&width=675)<br />其中![](assets/post_images/Learn-Rendering-Function/image_001.svg#from=paste&height=26&id=ud4d2b6f5&margin=%5Bobject%20Object%5D&originHeight=26&originWidth=82&originalType=url&status=done&style=none&taskId=u528090d5-3a7e-4c04-abd6-2b740219b9d&width=82)为自发光项，反射方程中的![](assets/post_images/Learn-Rendering-Function/image_002.svg#from=paste&height=20&id=ucb6907f8&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=39&originalType=url&status=done&style=none&taskId=u51575161-1e50-4938-a5db-ba1feec36cb&width=39)用，![](assets/post_images/Learn-Rendering-Function/image_003.svg#from=paste&height=18&id=uc0cadec9&margin=%5Bobject%20Object%5D&originHeight=18&originWidth=48&originalType=url&status=done&style=none&taskId=ua6266ff7-263b-4dec-8135-0cf9251c6bc&width=48)代替。 (tips：所有光线方向均指向外)<br />接下来从一个点光源和单个物体的场景开始理解渲染方程：<br />![](assets/post_images/Learn-Rendering-Function/image_004.jpg#from=paste&height=657&id=u035b5508&margin=%5Bobject%20Object%5D&originHeight=657&originWidth=930&originalType=url&status=done&style=none&taskId=u30f561ef-7efa-432c-ab01-7de9a2ca02a&width=930)<br />(点光源对一个点来说自然只有一个方向有入射光，所以这里没有了积分)<br />多个点光源一个物体的情况：<br />![](assets/post_images/Learn-Rendering-Function/image_005.jpeg#from=paste&height=494&id=ued2b1060&margin=%5Bobject%20Object%5D&originHeight=494&originWidth=720&originalType=url&status=done&style=none&taskId=u65dccea6-a3be-4897-b10f-30a732616e6&width=720)<br />将这些所有的点光源的贡献全部求和即可，那么如果点光源变成了面光源呢？如下图所示：<br />![](assets/post_images/Learn-Rendering-Function/image_006.jpeg#from=paste&height=488&id=u2fa50f4f&margin=%5Bobject%20Object%5D&originHeight=488&originWidth=720&originalType=url&status=done&style=none&taskId=uf0fb89f3-2567-4956-8407-86fbbce3c1b&width=720)<br />其实面光源就相当于无穷多个点光源的集合，只需要对 面光源所在的立体角范围进行积分，并且能够确定不同立体角方向的面光源的入射光radiance即可。<br />那么更进一步的，再在场景当中加入其它物体，使得物体之间发生光线交互之后是什么情况呢：<br />![](assets/post_images/Learn-Rendering-Function/image_007.jpeg#from=paste&height=664&id=u7a7e8f88&margin=%5Bobject%20Object%5D&originHeight=664&originWidth=1002&originalType=url&status=done&style=none&taskId=u39228808-6f88-4c21-80bc-b82ebe8acf6&width=1002)<br />如上图所示，可以把其它物体同样考虑成面光源，对其所占立体角进行积分即可，只不过对其它物体的立体角积分不像是面光源所有入射方向都有radiance，物体的立体角可能只有个别几个方向有入射的radiance(即多次物体间光线反射之后恰好照射到着色点x)，其它方向没有，但本质上都可以视作是面光源。<br />观察一下图中的渲染方程可以发现除了两个radiance，其它所有项都是知道的，可以将上式进一步写成如下图下方所示的式子：<br />![](assets/post_images/Learn-Rendering-Function/image_008.jpeg#from=paste&height=692&id=u7adae7bf&margin=%5Bobject%20Object%5D&originHeight=692&originWidth=949&originalType=url&status=done&style=none&taskId=u7c659315-72ac-43a5-8574-25693656f9f&width=949)<br />其中各项与原渲染方程中一一对应，(这里其实是有数学严格推导的，不过我们只是为了接下来构建直观的物理解释，对于这些推导不必在意，默认成立即可)，再接着，可以把该式子离散化写为线性代数的形式：<br />![](assets/post_images/Learn-Rendering-Function/image_009.jpeg#from=paste&height=600&id=uee940472&margin=%5Bobject%20Object%5D&originHeight=600&originWidth=905&originalType=url&status=done&style=none&taskId=u1f40b2bc-9fd5-4216-a1c1-eb07f9b1545&width=905)<br />呼，经过两步我们不是很清楚但其实是正确的数学推导之后，得到了这样一个式子：<br />![](assets/post_images/Learn-Rendering-Function/image_010.svg#from=paste&height=44&id=ue983ecb0&margin=%5Bobject%20Object%5D&originHeight=44&originWidth=675&originalType=url&status=done&style=none&taskId=u644ca86e-1aae-4f3c-953a-e8f5477d111&width=675)<br />其中L其实就是想要求得的反射光，E是自发光其实就是光源的发光项，K可以理解为对光线进行反射的一种算子操作(因为它由BRDF化来的)。那么利用线性代数的知识很容易就可以推导出L的结果如下：<br />![](assets/post_images/Learn-Rendering-Function/image_011.svg#from=paste&height=119&id=u5502b580&margin=%5Bobject%20Object%5D&originHeight=119&originWidth=675&originalType=url&status=done&style=none&taskId=u010f3605-0794-461d-b971-1342a9d9461&width=675)<br />其中![](assets/post_images/Learn-Rendering-Function/image_012.svg#from=paste&height=20&id=ud055ec3a&margin=%5Bobject%20Object%5D&originHeight=20&originWidth=11&originalType=url&status=done&style=none&taskId=uc64ea126-eb03-4811-807a-4c82577bb67&width=11)为单位矩阵，再接着对![](assets/post_images/Learn-Rendering-Function/image_013.svg#from=paste&height=29&id=u98694ab0&margin=%5Bobject%20Object%5D&originHeight=29&originWidth=92&originalType=url&status=done&style=none&taskId=u13eae111-f881-4552-9876-a5bd5e632a3&width=92)使用广义二项式定理得到：<br />![](assets/post_images/Learn-Rendering-Function/image_014.svg#from=paste&height=68&id=u7414a4bf&margin=%5Bobject%20Object%5D&originHeight=68&originWidth=675&originalType=url&status=done&style=none&taskId=u521bfb76-3650-4816-a8df-0ff0e2062dd&width=675)<br />仔细观察这个式子，注意E是光源所发出的光，K为反射算子，这样一个式子的物理含义如下图所示：<br />![](assets/post_images/Learn-Rendering-Function/image_015.jpeg#from=paste&height=506&id=u0e37ee21&margin=%5Bobject%20Object%5D&originHeight=506&originWidth=720&originalType=url&status=done&style=none&taskId=u051abbe1-40ea-4f86-91f1-d57a4da76d3&width=720)<br />E为光源发出的光，KE则代表对光源反射一次的结果，即直接光照，那么前两项之和就是光栅化当中着色所考虑的结果，对于全局光照来说，还考虑了![](assets/post_images/Learn-Rendering-Function/image_016.svg#from=paste&height=24&id=u2a229b90&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=44&originalType=url&status=done&style=none&taskId=u6cbae9e2-9365-42e0-9d54-79173ce9ec3&width=44)，即一次弹射的间接照明，![](assets/post_images/Learn-Rendering-Function/image_017.svg#from=paste&height=24&id=u7f5a3bc4&margin=%5Bobject%20Object%5D&originHeight=24&originWidth=44&originalType=url&status=done&style=none&taskId=u38613fdf-8b91-4ed8-adbc-90092b16d9a&width=44)就是两次弹射的间接照明，依次类推。<br />这样来看整个结果是不是就很清晰了，就是光源发光加上直接光照与多次间接光照的结果！而这一切都是从渲染方程推导而来的，因此这也正是渲染方程的物理意义！<br />最后以几张基于物理渲染的图片作为本篇文章的结束 一次反射直接光照：<br />![](assets/post_images/Learn-Rendering-Function/image_018.png#from=paste&height=539&id=uf3688d11&margin=%5Bobject%20Object%5D&originHeight=539&originWidth=720&originalType=url&status=done&style=none&taskId=uf6770bbf-0f0c-4f6c-ae0f-1bf1bf6a7e3&width=720)<br />两次反射，考虑到一次弹射的间接光照：<br />![](assets/post_images/Learn-Rendering-Function/image_019.jpeg#from=paste&height=690&id=udbb8cc11&margin=%5Bobject%20Object%5D&originHeight=690&originWidth=970&originalType=url&status=done&style=none&taskId=u4c53f7c3-47a8-4543-b328-d0d2ea89b42&width=970)<br />3次反射，考虑到两次弹射的间接光照：<br />![](assets/post_images/Learn-Rendering-Function/image_020.jpeg#from=paste&height=738&id=uf321254c&margin=%5Bobject%20Object%5D&originHeight=738&originWidth=985&originalType=url&status=done&style=none&taskId=ubd722515-08f5-43ad-9fe8-dab342c7e08&width=985)<br />(考虑次数越多越接近真实图片效果,趋近收敛)
